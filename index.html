<!DOCTYPE html>
<!--HTML5 doctype-->
<html>
     
<head>
  <title>SUR Visualizer</title>
  <meta charset="utf-8">
  
  <!-- CSS for Styling the page -->
  <link rel="stylesheet" type="text/css" href="css/command.css">
  <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.10.3.custom.min.css">
    
  <!-- Application Frameworks -->
  <script src="lib/jquery-1.9.1.js"></script>
  <script src="lib/jquery-ui-1.10.3.custom.min.js"></script>
	<script src="lib/three.min.js"></script>
  
  <!--Models helpers-->
  <script src="lib/STLLoader.js"></script>
  
  <!--GUI helpers-->
	<script src="lib/TrackballControls.js"></script>
  <script src="lib/TransformControls.js"></script>
  <script src="lib/FlyControls.js"></script>
  <script src="lib/FirstPersonControls.js"></script>
  
  <!--Debug helpers-->
	<script src="lib/Detector.js"></script>
	<script src="lib/stats.min.js"></script>
  
  <!-- SUR JS -->
  <!-- Order is important due to shared variables -->
  <!-- TODO: Make a global variable js file -->
  <script src="js/ws_mesh.js"></script>
  <script src="js/view_3d.js"></script>
  
  <script>
  /* Setup the operator websocket connection */
  var op_port = 8085;
  var op_ws;
  $(function(){
    var host = window.document.location.host.replace(/:.*/, '');
    if( host.length==0 ){ host = "localhost"; }
    var URL = window.URL || window.webkitURL;
    op_ws = new WebSocket('ws://' + host + ':' + op_port);
    /* Grab messages from the operator */
  	op_ws.onmessage = function(e){
  		if(typeof e.data === "string"){
        var op_data   = JSON.parse(e.data)
        var recv_time = e.timeStamp/1e6;
        var latency   = recv_time - op_data.t
        if (op_data.tool !== undefined) {
          console.log(op_data);
          tools[op_data.tool].position.set(
            -op_data.pos[1],op_data.pos[2],-op_data.pos[0]);
            //var axis = new THREE.Vector3(
              //op_data.ax[0],op_data.ax[1],op_data.ax[2] );
          //tools[op_data.tool].quaternion.setFromAxisAngle(axis, op_data.ang)
            
          tools[op_data.tool].quaternion.set(
            op_data.q[1], op_data.q[2], op_data.q[3], op_data.q[0] )
          var quaternion = new THREE.Quaternion();
          var m = new THREE.Matrix4();
          m.makeRotationX(Math.PI/2);
          quaternion.setFromRotationMatrix( m )
          tools[op_data.tool].quaternion.multiply(quaternion);
          m.makeRotationZ(Math.PI/2);
          quaternion.setFromRotationMatrix( m )
          tools[op_data.tool].quaternion.multiply(quaternion);
        }
  			//console.log('Operator Latency: '+latency*1000+'ms')
  			return;
  		}
    }; //onmessage
  });
  </script>
  
  <script>
  $(function() {
    $( "#settings" ).dialog({
      width: 640,
      height: 480,
      modal: true,
      autoOpen: false,
      buttons: {
        Send: function() {
          var command = {
            endpoints: $( "#slider-range" ).slider( "values" )
          }
          op_ws.send( JSON.stringify(command) );
          $( this ).dialog( "close" );
        }
      }
    });
  });
  </script>
  
  <script>
  /* Show the depth map */
  $(function() {
    $( "#images" ).dialog({
      width: 800,
      height: 600,
      modal: true,
      autoOpen: false,
    });
  });
  </script>
  
  <script>
  /* Buttons to update settings */
  $(function() {
    $( "a#req_btn" ).button().click(function( event ) {
      event.preventDefault();
      var request = {loc: 'chest', quality: 95, range: [.1,2] }
      fr_ws.send( JSON.stringify(request) );
    });
  });
  /* Buttons to update settings */
  $(function() {
    $( "a#dmap_btn" ).button().click(function( event ) {
      event.preventDefault();
      $( "#images" ).dialog("open");
    });
  });
  /* Buttons to update settings */
  $(function() {
    $( "a#settings_btn" ).button().click(function( event ) {
      event.preventDefault();
      $( "#settings" ).dialog("open");
    });
  });
  </script>
  
  <script>
  /* Slidar for the lidar scanning range */
  $(function() {
    $( "#slider-range" ).slider({
      range: true,
      min: -60,
      max: 60,
      values: [ -45, 45 ],
      slide: function( event, ui ) {
        $( "#endpoints" ).val( ui.values[ 0 ] + " to " + ui.values[ 1 ] );
      }
    });
    // Initialize
    var vals = $( "#slider-range" ).slider( "values" );
    $( "#endpoints" ).val( vals[ 0 ] + " to " + vals[ 1 ] );
  });
  </script>
  
</head>

<body>
  <div id="buttons">
    <a id="req_btn" class="btn">Get frame!</a>
    <br/>
    <a id="dmap_btn" class="btn">Depth Map</a>
    <br/>
    <a id="settings_btn" class="btn">Settings</a>
  </div>
  <div id="images">
    <canvas id="depthmap"/>
  </div>
  <div class="settings" id="settings" title="Basic modal dialog">
    <p>Please choose the minimum and maximum scanning range</p>
    <div id="slider-range"></div>
    <label for="endpoints">Lidar pan endpoints (degrees):</label>
    <input type="text" id="endpoints" />
  </div>
</body>

</html>